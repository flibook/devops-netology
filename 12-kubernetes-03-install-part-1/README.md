# 12.3. Развертывание кластера на собственных серверах, лекция 1
> Поработав с персональным кластером, можно заняться проектами. Вам пришла задача подготовить кластер под новый проект.

## Задание 1: Описать требования к кластеру
>Сначала проекту необходимо определить требуемые ресурсы. Известно, что проекту нужны база данных, система кеширования, а само приложение состоит из бекенда и фронтенда. Опишите, какие ресурсы нужны, если известно:
>
>* База данных должна быть отказоустойчивой. Потребляет 4 ГБ ОЗУ в работе, 1 ядро. 3 копии.
>* Кэш должен быть отказоустойчивый. Потребляет 4 ГБ ОЗУ в работе, 1 ядро. 3 копии.
>* Фронтенд обрабатывает внешние запросы быстро, отдавая статику. Потребляет не более 50 МБ ОЗУ на каждый экземпляр, 0.2 ядра. 5 копий.
>* Бекенд потребляет 600 МБ ОЗУ и по 1 ядру на копию. 10 копий.
>
>План расчета
>1. Сначала сделайте расчет всех необходимых ресурсов.
>2. Затем прикиньте количество рабочих нод, которые справятся с такой нагрузкой.
>3. Добавьте к полученным цифрам запас, который учитывает выход из строя как минимум одной ноды.
>4. Добавьте служебные ресурсы к нодам. Помните, что для разных типов нод требовния к ресурсам разные.
>5. Рассчитайте итоговые цифры.
>6. В результате должно быть указано количество нод и их параметры.

**Ответ**

1. Нам требуется:
   * БД - 3 копии * 1 ядро = 3 ядра и 3 копии * 4 ОЗУ = 12 ГБ ОЗУ
   * КЭШ - 3 копии * 1 ядро = 3 ядра и 3 копии * 4 ОЗУ = 12 ГБ ОЗУ
   * Фронт - 5 копий * 0.2 ядра = 1 ядро и 5 копий * 0.05 ОЗУ = 0.25 ГБ ОЗУ
   * Бек - 10 копий * 1 ядро = 10 ядер и 10 копий * 0.6 ГБ ОЗУ = 6 ГБ ОЗУ 
   * Итого - чистых требований на 3 + 3 + 1 + 10 = 17 ядер и 12 + 12 + 0.25 + 6 = 30.25 ГБ ОЗУ
2. Рабочие ноды:
   * Если рабочих нод 1, то все поды крутятся на ней:
     - т.е. нужно 17 ядер и 30.25 ГБ ОЗУ
   * Если рабочих нод 2, то можно расскидать поды так:
     - 2 БД + 1 КЭШ + 3 Фронта + 5 Бека = 2 * 1 + 1 * 1 + 3 * 0.2 + 5 * 1 = 8.6 ядра и 2 * 4 + 1 * 4 + 3 * 0.05 + 5 * 0.6 = 15.15 ГБ ОЗУ
     - 1 БД + 2 КЭШ + 2 Фронта + 5 Бека = 1 * 1 + 2 * 1 + 2 * 0.2 + 5 * 1 = 8.4 ядра и 1 * 4 + 2 * 4 + 2 * 0.05 + 5 * 0.6 = 15.1 ГБ ОЗУ
   * Если рабочих нод 3, то можно расскидать поды так: 
     - 1 БД + 1 КЭШ + 2 Фронта + 3 Бека = 1 + 1 + 2 * 0.2 + 3 * 1 = 5.4 ядра и 4 + 4 + 2 * 0.05 + 3 * 0.6 = 9.9 ГБ ОЗУ
     - 1 БД + 1 КЭШ + 2 Фронта + 3 Бека = 1 + 1 + 2 * 0.2 + 3 * 1 = 5.4 ядра и 4 + 4 + 2 * 0.05 + 3 * 0.6 = 9.9 ГБ ОЗУ
     - 1 БД + 1 КЭШ + 1 Фронт + 4 Бека =  1 + 1 + 1 * 0.2 + 4 * 1 = 6.2 ядра и 4 + 4 + 1 * 0.05 + 4 * 0.6 = 10.45 ГБ ОЗУ
   * Если рабочих нод 4, то можно расскидать поды так:
     - 1 БД + 0 КЭШ + 2 Фронта + 2 Бека = 1 + 0 + 2 * 0.2 + 2 * 1 = 3.4 ядра и 4 + 0 + 2 * 0.05 + 2 * 0.6 = 5.3 ГБ ОЗУ
     - 0 БД + 1 КЭШ + 1 Фронта + 2 Бека = 0 + 1 + 1 * 0.2 + 2 * 1 = 3.2 ядра и 0 + 4 + 1 * 0.05 + 2 * 0.6 = 5.25 ГБ ОЗУ
     - 1 БД + 1 КЭШ + 1 Фронта + 3 Бека = 1 + 1 + 1 * 0.2 + 3 * 1 = 5.2 ядра и 4 + 4 + 1 * 0.05 + 3 * 0.6 = 9.85 ГБ ОЗУ
     - 1 БД + 1 КЭШ + 1 Фронта + 3 Бека = 1 + 1 + 1 * 0.2 + 3 * 1 = 5.2 ядра и 4 + 4 + 1 * 0.05 + 3 * 0.6 = 9.85 ГБ ОЗУ
   * Если рабочих нод 5, то можно расскидать поды так:
     - 1 БД + 0 КЭШ + 1 Фронта + 2 Бека = 1 + 0 + 1 * 0.2 + 2 * 1 = 3.2 ядра и 4 + 0 + 1 * 0.05 + 2 * 0.6 = 5.25 ГБ ОЗУ
     - 1 БД + 0 КЭШ + 1 Фронта + 2 Бека = 1 + 0 + 1 * 0.2 + 2 * 1 = 3.2 ядра и 4 + 0 + 1 * 0.05 + 2 * 0.6 = 5.25 ГБ ОЗУ
     - 0 БД + 1 КЭШ + 1 Фронта + 2 Бека = 0 + 1 + 1 * 0.2 + 2 * 1 = 3.2 ядра и 0 + 4 + 1 * 0.05 + 2 * 0.6 = 5.25 ГБ ОЗУ
     - 0 БД + 1 КЭШ + 1 Фронта + 2 Бека = 0 + 1 + 1 * 0.2 + 2 * 1 = 3.2 ядра и 0 + 4 + 1 * 0.05 + 2 * 0.6 = 5.25 ГБ ОЗУ
     - 1 БД + 1 КЭШ + 1 Фронта + 2 Бека = 1 + 1 + 1 * 0.2 + 2 * 1 = 4.2 ядра и 4 + 4 + 1 * 0.05 + 2 * 0.6 = 9.25 ГБ ОЗУ
   * Если рабочих нод 6, то можно расскидать поды так:
     - 1 БД + 0 КЭШ + 1 Фронта + 2 Бека = 1 + 0 + 1 * 0.2 + 2 * 1 = 3.2 ядра и 4 + 0 + 1 * 0.05 + 2 * 0.6 = 5.25 ГБ ОЗУ
     - 1 БД + 0 КЭШ + 1 Фронта + 2 Бека = 1 + 0 + 1 * 0.2 + 2 * 1 = 3.2 ядра и 4 + 0 + 1 * 0.05 + 2 * 0.6 = 5.25 ГБ ОЗУ
     - 1 БД + 0 КЭШ + 0 Фронта + 1 Бека = 1 + 0 + 0 * 0.2 + 1 * 1 = 2.0 ядра и 4 + 0 + 0 * 0.05 + 1 * 0.6 = 4.6 ГБ ОЗУ
     - 0 БД + 1 КЭШ + 1 Фронта + 1 Бека = 0 + 1 + 1 * 0.2 + 1 * 1 = 2.2 ядра и 0 + 4 + 1 * 0.05 + 1 * 0.6 = 4.65 ГБ ОЗУ
     - 0 БД + 1 КЭШ + 1 Фронта + 2 Бека = 0 + 1 + 1 * 0.2 + 2 * 1 = 3.2 ядра и 0 + 4 + 1 * 0.05 + 2 * 0.6 = 5.25 ГБ ОЗУ
     - 0 БД + 1 КЭШ + 1 Фронта + 2 Бека = 0 + 1 + 1 * 0.2 + 2 * 1 = 3.2 ядра и 0 + 4 + 1 * 0.05 + 2 * 0.6 = 5.25 ГБ ОЗУ
   * Увеличивать дальше количество нод нецелесообразно, т.к. затраты на "инфраструктуру" будут больше полезной нагрузки
3. В случае отказа ноды (если что-то может пойти не так, значит так и случится, поэтому откажет самая "мощная" нода), мы просто попадаем в конфигурацию N-1
4. Служебные ресурсы на каждую ноду:
   * OS 100MB, 0.1 vCPU
   * Kubelet 1.8GB, 0.07 vCPU
   * Eviction threshold  100MB, 0 vCPU
   * kube-proxy 128MB, 0.1 vCPU 
   * Итого 0.3 ядра и 2 Гб ОЗУ (эти цифры нужно прибивать к каждой ноде)
5. С учётом того, что мы не можем купить нецелое (и даже нечётное) количество ядер, а объём ОЗУ должен быть кратен количеству ядер, получим 
   * 1 нода: 
     - 20 ядер, 40 Гб ОЗУ (23184 руб/мес)
     - В случае отказа сервис станет полностью недоступен, что не подходит по требованиям
   * 2 ноды:
     - 10 ядер, 20 Гб ОЗУ (11592 руб/мес)
     - 10 ядер, 20 Гб ОЗУ
     - На случай отказа каждая из нод должна соответствовать характеристикам предыдущего варианта, т.е. расходы будут 46368 руб/мес вместо 23184 руб/мес 
   * 3 ноды:
     - 6 ядер, 12 ГБ ОЗУ (6955 руб/мес)
     - 6 ядер, 12 ГБ ОЗУ
     - 8 ядер, 16 ГБ ОЗУ (9274 руб/мес)
     - Аналогично требуемые расходы = 23184 руб/мес, на случай отказа 3 * 11592 = 34776 руб/мес
   * 4 ноды:
     - 4 ядра, 8 ГБ ОЗУ (4637 руб/мес)
     - 4 ядра, 8 ГБ ОЗУ
     - 6 ядер, 12 ГБ ОЗУ
     - 6 ядер, 12 ГБ ОЗУ
     - Требуемые расходы = 23184 руб/мес, на случай отказа 2 * 6955 + 2 * 9274 = 32458 руб/мес
   * 5 нод:
     - 4 ядра, 8 ГБ ОЗУ
     - 4 ядра, 8 ГБ ОЗУ
     - 4 ядра, 8 ГБ ОЗУ
     - 4 ядра, 8 ГБ ОЗУ
     - 6 ядер, 12 ГБ ОЗУ
     - Требуемые расходы = 25503 руб/мес, на случай отказа 2 * 4637 + 3 * 6955 = 30139 руб/мес
   * 6 нод:
     - Все одинаковые 4 ядер, 8 ГБ ОЗУ
     - Требуемые расходы = 27822 руб/мес, на случай отказа 4 * 4637 + 2 * 6955 = 32458 руб/мес
6. Итого наиболее выгодной оказалась конфигурация с 5 рабочими нодами: 
   * Рабочие ноды: 2 ноды по (4 ядра, 8 ГБ ОЗУ) и 3 ноды по (6 ядер, 12 ГБ ОЗУ)
   * Мастер ноды: 3 ноды (2 ядра, 2 ГБ ОЗУ), т.к. нам и на них необходимо обеспечить отказоустойчивость, поэтому нужно нечётное количество нод большее 1
   * ETCD и балансировщик: 3 ноды (2 ядра, 2 ГБ ОЗУ)
